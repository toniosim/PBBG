<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Browser Based Game</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">
    <!-- Add Vue.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Add Socket.IO client library -->
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
</head>
<body>
    <div id="app" class="game-container">
        <header class="game-header d-flex justify-content-between align-items-center">
            <div class="fs-4 fw-bold">Browser Game</div>
            <div class="d-flex align-items-center">
                <span id="player-name" class="me-3">{{ character.name || 'Loading...' }}</span>
                <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </header>

        <main class="container-fluid py-3 flex-grow-1">
            <div class="row h-100">
                <div class="col-md-6 d-flex flex-column mb-3 mb-md-0">
                    <!-- Character Card -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Character</h5>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ character.name }}</h5>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">
                                    <span>Health:</span>
                                    <span>{{ character.health }}/{{ character.max_health }}</span>
                                </label>
                                <div class="progress">
                                    <div class="progress-bar health-bar" role="progressbar"
                                         :style="{ width: healthPercent + '%' }"
                                         :aria-valuenow="character.health"
                                         :aria-valuemin="0"
                                         :aria-valuemax="character.max_health"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">
                                    <span>MP:</span>
                                    <span>{{ character.mp }}/{{ character.max_mp }}</span>
                                </label>
                                <div class="progress">
                                    <div class="progress-bar mp-bar" role="progressbar"
                                         :style="{ width: mpPercent + '%' }"
                                         :aria-valuenow="character.mp"
                                         :aria-valuemin="0"
                                         :aria-valuemax="character.max_mp"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">
                                    <span>AP:</span>
                                    <span>{{ character.ap }}/{{ character.max_ap }}</span>
                                </label>
                                <div class="progress">
                                    <div class="progress-bar ap-bar" role="progressbar"
                                         :style="{ width: apPercent + '%' }"
                                         :aria-valuenow="character.ap"
                                         :aria-valuemin="0"
                                         :aria-valuemax="character.max_ap"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="fw-medium">Experience:</span>
                                <span>{{ character.experience }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Location Card -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Location</h5>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ location.name || 'Unknown' }}</h5>
                            <p>{{ location.description || 'Loading location information...' }}</p>
                            <div v-if="location.inside_building" class="mt-3">
                                <span class="building-indicator">Inside Building</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Card -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button
                                    v-for="action in availableActions"
                                    :key="action.type"
                                    class="btn btn-outline-primary"
                                    :disabled="!canPerformAction(action.type)"
                                    @click="handleAction(action)"
                                >
                                    {{ action.name }}
                                </button>
                                <p v-if="availableActions.length === 0" class="text-muted">Loading available actions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 d-flex flex-column">
                    <!-- Map Card -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Map</h5>
                        </div>
                        <div class="card-body">
                            <div class="game-map">
                                <div
                                    v-for="(tile, index) in mapTiles"
                                    :key="index"
                                    class="map-tile"
                                    :class="{ current: tile.x === currentX && tile.y === currentY }"
                                    @click="tileClick(tile)"
                                >
                                    <div class="map-tile-name">({{ tile.x }}, {{ tile.y }})</div>
                                    <div v-if="tile.has_building" class="building-marker"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Log Card -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Action Log</h5>
                        </div>
                        <div class="card-body">
                            <div class="log-container">
                                <div v-for="(log, index) in logs" :key="index" class="log-entry">
                                    <span class="log-time">{{ formatLogTime(log.created_at) }}</span>
                                    <span class="log-message">{{ log.message }}</span>
                                </div>
                                <p v-if="logs.length === 0" class="text-muted">Welcome to the game!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal for action confirmation/options -->
        <div class="modal fade" :class="{ show: showModal }" tabindex="-1"
             :style="{ display: showModal ? 'block' : 'none' }"
             :aria-modal="showModal ? 'true' : 'false'" :aria-hidden="!showModal ? 'true' : 'false'">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ modalTitle }}</h5>
                        <button type="button" class="btn-close" @click="hideModal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Move Direction Buttons -->
                        <div v-if="modalActionType === 'MOVE'" class="directions-container">
                            <button
                                v-for="option in modalOptions"
                                :key="option.value"
                                class="btn-direction"
                                @click="performAction(modalActionType, { direction: option.value })"
                            >
                                {{ option.label }}
                            </button>
                        </div>

                        <!-- Other action options -->
                        <select v-else-if="modalOptions.length > 0" v-model="selectedOption" class="form-select">
                            <option
                                v-for="option in modalOptions"
                                :key="option.value"
                                :value="option.value"
                            >
                                {{ option.label }}
                            </option>
                        </select>

                        <!-- Confirmation message -->
                        <p v-else>Are you sure you want to {{ modalAction.toLowerCase() }}?</p>
                    </div>
                    <div class="modal-footer">
                        <button
                            v-if="modalOptions.length === 0 || (modalOptions.length > 0 && modalActionType !== 'MOVE')"
                            class="btn btn-primary"
                            @click="confirmAction"
                        >
                            Confirm
                        </button>
                        <button class="btn btn-secondary" @click="hideModal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade" :class="{ show: showModal }" :style="{ display: showModal ? 'block' : 'none' }"></div>

        <!-- Toast message -->
        <div v-if="showToast" class="toast" :class="toastType">
            {{ toastMessage }}
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/vue-game.js"></script>
</body>
</html>